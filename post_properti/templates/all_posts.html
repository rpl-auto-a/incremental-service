{% extends "base.html" %}
<!-- Placeholder sementara  -->

{% block meta %}
<title>All Posts | RentAcross</title>
{% endblock meta %}

{% block content %}
<h2 class="text-center text-3xl block font-bold text-gray-700 py-8">All Posts</h2>

<!-- Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 pb-8" id="posts">

</div>
{% endblock content %}

{% block script %}
<script>
    // Check if the user is authenticated
    const isAuthenticated = "{{ request.user.is_authenticated }}" == "True"? true : false;

    async function getAllPosts() {
        return fetch("{% url 'all_posts_json' %}").then((res) => res.json());
    }

    async function getFavoritePosts() {
        // Only fetch favorite posts if the user is authenticated
        if (isAuthenticated) {
            return fetch("{% url 'userData:favorites_json' %}").then((res) => res.json());
        } else {
            return [];
        }
    }

    async function refreshPosts() {
        document.getElementById("posts").innerHTML = "";
        const posts = await getAllPosts();
        const favoritePosts = isAuthenticated? await getFavoritePosts() : [];
        let htmlString = ``;

        if (posts.length == 0) {
            htmlString += `<span>*No Posts Yet</span>`;
        } else {
            posts.forEach((post) => {
                const postDetailUrl = `/posts/${post.pk}/`;
                const isFavorite = isAuthenticated? favoritePosts.some(favorite => favorite.pk === post.pk) : [] ;

                htmlString += `
                    <div class="max-w-xs relative rounded overflow-hidden shadow-lg h-96">
                        <a href=${postDetailUrl}>
                            <img class="w-full h-48 object-scale-down" src="${post.fields.foto_properti}" alt="Foto properti">
                            <div class="px-6 py-4">
                                <div class="font-bold line-clamp-2 text-xl mb-2">${post.fields.nama_properti}</div>
                                <p class="text-gray-700 line-clamp-2 text-base">${post.fields.deskripsi_properti}</p>
                            </div>
                            <div class="px-6 pt-2 pb-2 absolute bottom-0 line-clamp-1">
                                <span class="inline-block bg-gray-200 rounded-full px-3 py-1 text-sm font-semibold text-gray-700 mr-2 mb-2">${post.fields.kota_properti}, ${post.fields.negara_properti}</span>
                            </div>
                        </a>
                        
                        ${isAuthenticated ? `
                            <button class="bg-${isFavorite ? 'red-500' : 'blue-500'} text-white px-4 mx-6 py-1 rounded-md ${isFavorite ? 'cursor-not-allowed' : 'hover:bg-blue-700'}" onclick="addToFavorites(${post.pk})" ${isFavorite ? 'disabled' : ''}>
                                ${isFavorite ? 'In Favorites' : 'Add to Favorites'}
                            </button>
                        ` : ''}
                    </div>
                `;
            });
        }
        document.getElementById("posts").innerHTML = htmlString;
    }

    async function addToFavorites(postId) {
        if (!isAuthenticated) {
            // Handle the case when the user is not authenticated
            alert("Please log in to add posts to favorites.");
            return;
        }

        try {
            const response = await fetch(`{% url 'userData:add_favorite' post_id=0 %}`.replace('0', postId), {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({})
            });

            if (response.ok) {
                const data = await response.json();
                refreshPosts();
            } else if (response.status === 404) {
                alert("Post not found");
            } else {
                alert("Error adding to favorites");
            }
        } catch (error) {
            console.error("Error adding to favorites", error);
            alert("Error adding to favorites");
        }
    }

    refreshPosts();
</script>
{% endblock script %}
